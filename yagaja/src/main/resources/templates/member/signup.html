<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>íšŒì›ê°€ì…</title>
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/signup_style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
</head>
<body>
  <form method="post" class="form" id="signupForm">
    <fieldset class="fieldset">
      <legend>íšŒì›ê°€ì…</legend>
      <h2 class="logo">Yagaja</h2>

      <!-- ì•„ì´ë”” -->
      <div class="row">
        <label for="userId" class="userLabel">ì•„ì´ë””</label>
        <input type="text" id="userId" name="userId" class="emailInput" placeholder="ì•„ì´ë”” ì…ë ¥"required />
        <button type="button" id="btnCheckId" class="button2">ì¤‘ë³µí™•ì¸</button>
        <p id="userIdError"></p>
      </div>

      <!-- ë¹„ë°€ë²ˆí˜¸ -->
      <div class="row">
        <label for="userPw" class="userLabel">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="userPw" name="userPw" class="userInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required/>
        <p id="userPwError"></p>
      </div>

      <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
      <div class="row">
        <label for="userCp" class="userLabel">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input type="password" id="userCp" name="userCp" class="userInput" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥"required />
        <p id="userCpError"></p>
      </div>

      <!-- ì´ë¦„ -->
      <div class="row">
        <label for="userName" class="userLabel">ì´ë¦„</label>
        <input type="text" id="userName" name="userName" class="userInput" placeholder="ì´ë¦„ ì…ë ¥" required />
        <p id="userNameError"></p>
      </div>

      <!-- ì „í™”ë²ˆí˜¸ -->
      <div class="row">
        <label for="phoneNum" class="userLabel">ì „í™”ë²ˆí˜¸</label>
        <input type="tel" id="phoneNum" name="phoneNum" class="userInput" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥ (-ì œì™¸í•œ ìˆ«ìë§Œ)" />
        <p id="phoneNumError"></p>
      </div>

      <!-- ìƒë…„ì›”ì¼ -->
      <div class="row">
        <label for="birth" class="userLabel">ìƒë…„ì›”ì¼</label>
        <input type="tel" id="birth" name="birth" class="userInput" placeholder="ìƒë…„ì›”ì¼ ì…ë ¥ (ì˜ˆ: 950101)" required/>
        <p id="birthError"></p>
      </div>

      <!-- ì´ë©”ì¼ -->
      <div class="row">
        <label for="email" class="userLabel">ì´ë©”ì¼</label>
        <input type="email" id="email" name="email" class="emailInput" placeholder="ì´ë©”ì¼ ì…ë ¥"required />
        <button type="button" id="btnSendCode" class="button2">ì¸ì¦ë²ˆí˜¸</button>
        <span id="timer" style="font-size: 14px; color: red;"></span>
        <p id="emailError"></p>
      </div>

      <!-- ì¸ì¦ë²ˆí˜¸ -->
      <div class="row">
        <label for="Verification" class="userLabel">ì¸ì¦ë²ˆí˜¸</label>
        <input type="text" id="Verification" name="Verification" class="userInput" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" required/>
        <p id="VerificationError"></p>
      </div>

      <!-- íšŒì›ê°€ì… ë²„íŠ¼ -->
      <div class="row">
        <button type="submit" class="button" id="btnSubmit">íšŒì›ê°€ì…</button>
      </div>
    </fieldset>
  </form>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    $.validator.addMethod("regex", function (value, element, regexp) {
      // ì •ê·œì‹ì´ ë¬¸ìì—´ì´ ì•„ë‹ˆë¼ RegExp ê°ì²´ì¼ ê²½ìš°ë§Œ ì²˜ë¦¬
      if (regexp instanceof RegExp) {
        return this.optional(element) || regexp.test(value);
      }
      return true;
    }, "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    
    // jQuery Validation ì„¤ì •
    $("#signupForm").validate({
      rules: {
        userId: {
          required: true,
          minlength: 5,
          maxlength: 20,
          regex: /^[a-z0-9]+$/
        },
        userPw: {
          required: true,
          minlength: 8,
          maxlength: 20,
          regex: /^(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*()]).+$/
        },
        userCp: {
          required: true,
          equalTo: "#userPw"
        },
        userName: {
          required: true,
          regex: /^[ê°€-í£]{2,}$/
        },
        phoneNum: {
          required: true,
          regex: /^\d{10,11}$/
        },
        birth: {
          required: true,
          regex: /^\d{6}$/
        },
        email: {
          required: true,
          email: true,
          regex:/^[a-zA-Z0-9._%+-]+@(naver\.com|daum\.net|hanmail\.net|nate\.com)$/
        },
        Verification: {
          required: true
        }
      },
      messages: {
        userId: {
          required: "ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.",
          minlength: "ì•„ì´ë””ëŠ” 5ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.",
          maxlength: "ì•„ì´ë””ëŠ” 20ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.",
          regex: "ì˜ë¬¸ ì†Œë¬¸ìì™€ ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."
        },
        userPw: {
          required: "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.",
          minlength: "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.",
          regex: "ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤."
        },
        userCp: {
          required: "ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•˜ì„¸ìš”.",
          equalTo: "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        },
        userName: {
          required: "ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",
          regex: "ì´ë¦„ì€ í•œê¸€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
        },
        phoneNum: {
          required: "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.",
          regex: "ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (10~11ìë¦¬)"
        },
        birth: {
          required: "ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.",
          regex: "ì˜ˆ: 950101 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
        },
        email: {
          required: "ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.",
          email: "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.",
          regex: "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."
        },
        Verification: {
          required: "ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        }
      },
      errorPlacement: function (error, element) {
        const id = element.attr("id");
        $(`#${id}Error`).html(error);
      },
      submitHandler: function () {
        const request = {
          userId: $("#userId").val(),
          userPw: $("#userPw").val(),
          userName: $("#userName").val(),
          phoneNum: $("#phoneNum").val(),
          birthDate: $("#birth").val(),
          email: $("#email").val()
        };

        fetch("/member/joinAction", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(request)
        })
        .then(res => res.json())
        .then(data => {
          if (data.result === "success") {
            Swal.fire("ğŸ‰ ê°€ì… ì™„ë£Œ", "íšŒì›ê°€ì…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
          } else {
            Swal.fire("ğŸš« ê°€ì… ì‹¤íŒ¨", "ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
          }
        });

        return false;
      }
    });

    $(document).ready(function () {
      // ì´ë©”ì¼ ì¸ì¦ ìƒíƒœ ë³€ìˆ˜
      let isCodeSent = false;

      // ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
      $("#btnCheckId").on("click", function () {
        const userId = $("#userId").val().trim();
        if (!userId) {
          return Swal.fire("âš ï¸ ì…ë ¥ ì˜¤ë¥˜", "ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "warning");
        }
        fetch(`/member/checkId?userId=${userId}`)
          .then(res => res.json())
          .then(data => {
            if (data.duplicate) {
              Swal.fire("ì¤‘ë³µëœ ì•„ì´ë””", "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.", "error");
            }
            if (userId.length < 5 || userId.length > 20) {
              return Swal.fire("âŒ ê¸¸ì´ ì˜¤ë¥˜", "ì•„ì´ë””ëŠ” 5ì ì´ìƒ 20ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
            } else {
              Swal.fire("ì‚¬ìš© ê°€ëŠ¥", "ì´ ì•„ì´ë””ëŠ” ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "success");
            }
          });
      });

      // ì´ë©”ì¼ ì¸ì¦ íƒ€ì´ë¨¸
      let countdown;
      let timerSeconds = 180;

      $("#btnSendCode").on("click", function (e) {
        e.preventDefault();

        const email = $("#email").val().trim();

        // ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šìœ¼ë©´ íƒ€ì´ë¨¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
        const emailRegex = /^[a-zA-Z0-9._%+-]+@(naver\.com|daum\.net|hanmail\.net|nate\.com)$/;
        if (!emailRegex.test(email)) {
          return Swal.fire("âš ï¸ ì´ë©”ì¼ í˜•ì‹ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        }

        // ì¸ì¦ ì½”ë“œê°€ ì´ë¯¸ ì „ì†¡ëœ ìƒíƒœì¼ ê²½ìš° ë²„íŠ¼ì„ ëˆŒëŸ¬ë„ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ
        if (isCodeSent) {
          return Swal.fire("âš ï¸ ì´ë¯¸ ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", "ì¸ì¦ë²ˆí˜¸ëŠ” í•œ ë²ˆë§Œ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "warning");
        }

        isCodeSent = true; // ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸
        clearInterval(countdown);
        timerSeconds = 180;
        $("#Verification").prop("disabled", false);
        startTimer();
      });

      function startTimer() {
        const timerEl = $("#timer");
        countdown = setInterval(() => {
          const minutes = Math.floor(timerSeconds / 60);
          const seconds = String(timerSeconds % 60).padStart(2, "0");
          timerEl.text(`â³ ë‚¨ì€ ì‹œê°„: ${minutes}:${seconds}`);
          if (timerSeconds-- <= 0) {
            clearInterval(countdown);
            timerEl.text("â° ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            $("#Verification").prop("disabled", true);
          }
        }, 1000);
      }
    });
  </script>
</body>
</html>
