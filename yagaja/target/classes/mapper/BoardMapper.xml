<?xml version="1.0" encoding="UTF-8"?>

<!-- MyBatisì—ì„œ ì‚¬ìš©í•  ë§¤í¼ ì„¤ì •: DTD(Document Type Definition) ëª…ì‹œ -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ì´ XML íŒŒì¼ì´ ì—°ê²°ë  Mapper ì¸í„°íŽ˜ì´ìŠ¤ ì§€ì • -->
<mapper namespace="com.trip.webpage.mapper.BoardMapper">

<!--  1ê±´ ì¡°íšŒ ì¿¼ë¦¬  2025-05-22 ì¡°ìœ¤í˜¸   -->
<select id="selectOne" parameterType="Long" resultType="BoardDefaultVO">
SELECT bd.BOD_IDX
, bd.BOD_CONSTENT
, bd.BOD_TITLE
, bd.REG2_DATE
, bd.REG_ID
, count(lc.BOD_IDX) AS likeCnt
, B.cnt AS reportCnt
FROM BOARD_DEFAULT bd
LEFT OUTER JOIN LIKE_CNT lc ON bd.BOD_IDX = lc.BOD_IDX
LEFT OUTER JOIN (
SELECT COUNT(*) AS cnt, BOD_IDX FROM REPORT_CNT WHERE BOD_IDX = #{bodIdx}
GROUP BY BOD_IDX
) B ON B.BOD_IDX = bd.BOD_IDX
WHERE
bd.BOD_IDX = #{bodIdx}
GROUP BY bd.BOD_IDX, bd.BOD_CONSTENT, bd.BOD_TITLE , bd.REG2_DATE ,bd.REG_ID, B.cnt
</select>

<!--  ëª©ë¡ ì¡°íšŒ ì¿¼ë¦¬  -->
<select id="selectList2" parameterType="SearchHelper" resultType="BoardDefaultVO">
SELECT * FROM BOARD_DEFAULT WHERE 1 = 1
<if test="cate != null and cate != ''"> AND cate = #{cate} </if>
<if test="bodIdx != null and bodIdx != ''"> AND BOD_IDX = #{bodIdx} </if>
<if test="userId != null and userId != ''"> AND USER_ID LIKE '%' || #{userId} || '%' </if>
<if test="bodTitle != null and bodTitle != ''"> AND BOD_TITLE LIKE '%' || #{bodTitle} || '%' </if>
ORDER BY REG2_DATE DESC
</select>

<select id="selectList" parameterType="SearchHelper" resultType="BoardDefaultVO">
  SELECT *
  FROM BOARD_DEFAULT
  WHERE 1 = 1
  AND IS_VISIBLE = 'N'
  <if test="cate != null and cate != ''">
    AND CATE = #{cate}
  </if>
  <if test="bodIdx != null and bodIdx != ''">
    AND BOD_IDX = #{bodIdx}
  </if>
  <if test="userId != null and userId != ''">
    AND USER_ID LIKE '%' || #{userId} || '%'
  </if>
  <if test="bodTitle != null and bodTitle != ''">
    AND BOD_TITLE LIKE '%' || #{bodTitle} || '%'
  </if>
  ORDER BY REG2_DATE DESC
  OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
</select>


<!--  ëª©ë¡ ì¹´ìš´íŠ¸ ì¿¼ë¦¬   2025-05-22 ì¡°ìœ¤í˜¸   -->
<select id="selectListCount" parameterType="SearchHelper" resultType="int">
SELECT COUNT(*) AS CNT FROM BOARD_DEFAULT
<where>
<if test="cate != null"> AND cate = #{cate} </if>
<if test="bodIdx != null"> AND BOD_IDX = #{bodIdx} </if>
<if test="userId != null and userId != ''"> AND USER_ID = #{userId} </if>
</where>
ORDER BY BOD_IDX DESC
</select>

<!-- ê¸°ë³¸ì •ë³´ ë“¤ì–´ê°€ëŠ” ìžë£Œí˜• ì‚­ì œí•¨  2025-05-22 ì¡°ìœ¤í˜¸  -->
<!-- 2025-05-26 ì¡°ìœ¤í˜¸  ì´ê±° ì „ë¶€ ë³µì‚¬ -->
<insert id="insertBoard" parameterType="BoardDefaultVO" useGeneratedKeys="true" keyProperty="bodIdx" keyColumn="BOD_IDX"> INSERT INTO BOARD_DEFAULT ( BOD_TITLE, BOD_CONSTENT, user_id, reg2_date, update_date, CATE, REG_ID, UPDATE_ID ) VALUES ( #{bodTitle}, #{bodConstent}, #{userId}, #{reg2Date}, #{updateDate}, #{cate}, #{regId}, #{regId} ) </insert>

<!-- 2025-05-22 ì¡°ìœ¤í˜¸  idì„ íƒí•´ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ë””ë¹„ì„¤ê³„ ì•„ë§ˆ ì‚­ì œ ë ê²ƒê°™ìŒ -->
<select id="selectLatestByUserId" resultType="BoardDefaultVO" parameterType="String"> 
	SELECT b.BOD_IDX, b.BOD_TITLE, b.REG2_DATE AS createdAt, m.USER_NAME FROM BOARD_DEFAULT b JOIN MEMBER m ON b.USER_ID = m.USER_ID WHERE b.USER_ID = #{userId} ORDER BY b.REG2_DATE DESC 
</select>

<update id="updateBoard" parameterType="BoardDefaultVO">
  UPDATE board_default
  <set>
    <if test="cate != null"> cate = #{cate}, </if>
    <if test="bodTitle != null"> bod_title = #{bodTitle}, </if>
    <if test="bodConstent != null"> bod_constent = #{bodConstent}, </if>
    <if test="updateId != null"> update_id = #{updateId}, </if>
    update_date = SYSDATE, 
    <if test="fileMstId != null"> file_mst_id = #{fileMstId}, </if>
    <if test="userId != null"> user_id = #{userId}, </if>
    <if test="isVisible != null"> is_visible = #{isVisible} </if>
  </set>
  WHERE bod_idx = #{bodIdx}
</update>

<!-- ê²Œì‹œê¸€ ì‚­ì œ -->
<delete id="deleteBoard" parameterType="long">
  DELETE FROM BOARD_DEFAULT
  WHERE BOD_IDX = #{bodIdx}
</delete>

<!-- ì´ë¯¸ ì¢‹ì•„ìš” ëˆŒë €ëŠ”ì§€ í™•ì¸ 2025-05-27 ì¡°ìœ¤í˜¸ -->
<select id="hasUserLiked" resultType="boolean">
    SELECT CASE WHEN count(*) > 0 THEN 1 ELSE 0 END AS result 
    FROM LIKE_CNT
    WHERE BOD_IDX = #{bodIdx} AND USER_ID = #{userId}
</select>

<!-- ì¢‹ì•„ìš” insert ì¿¼ë¦¬: ì¤‘ë³µëœ ê²½ìš° ì—ëŸ¬ ë°œìƒí•¨ (PK ê±¸ë ¤ìžˆìŒ)  2025-05-27 ì¡°ìœ¤í˜¸-->
<insert id="insertLike" parameterType="map">
    INSERT INTO LIKE_CNT (BOD_IDX, USER_ID)
    VALUES (#{bodIdx}, #{userId})
</insert>

<!-- 2025-05-26 ì¡°ìœ¤í˜¸  ê¸€ ì¡°íšŒ ì‹œ ì¡°íšŒìˆ˜ 1 ì¦ê°€ -->
<update id="updateUserCnt" parameterType="long">
    UPDATE board_default 
    SET user_cnt = user_cnt + 1 
    WHERE BOD_IDX = #{bodIdx}
</update>

<!-- ëŒ“ê¸€ ì €ìž¥ -->
<insert id="insertComment" parameterType="CommentVO">
        INSERT INTO comments (
           content, REG_ID, UPD_ID, USER_ID, BOD_IDX
        ) VALUES (
            #{content}, #{userId}, #{userId}, 
            #{userId}, #{bodIdx}
        )
</insert>

<!-- ëŒ“ê¸€ ì—…ë°ì´íŠ¸ -->
<update id="updateComment" parameterType="CommentVO">
    UPDATE comments
    SET
        content = #{content},
        upd_id = #{userId},
        upd_date = SYSDATE
    WHERE
        COM_IDX = #{comIdx}
</update>

<!-- ëŒ“ê¸€ ì‚­ì œ -->
<delete id="deleteComment" parameterType="Long">
    DELETE FROM comments
    WHERE COM_IDX = #{comIdx}
</delete>


<!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
<select id="selectCommentList" parameterType="long" resultType="CommentVO">
        SELECT *
        FROM comments
        WHERE bod_idx = #{bodIdx}
          AND is_visible = 'N'
        ORDER BY REG_DATE DESC
</select>

<!--2025-05-28 ì¡°ìœ¤í˜¸-->
	 <!-- â¤ï¸ ì¢‹ì•„ìš” ì¶”ê°€ (LIKE_CNT í…Œì´ë¸”ì— ì‚½ìž…) -->
	<insert id="addLike">
	    INSERT INTO LIKE_CNT (BOD_IDX, USER_ID) VALUES (#{bodIdx}, #{userId})
	</insert>
	
	<!-- ðŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ (LIKE_CNT í…Œì´ë¸”ì—ì„œ ì‚­ì œ) -->
	<delete id="removeLike">
	    DELETE FROM LIKE_CNT WHERE BOD_IDX = #{bodIdx} AND USER_ID = #{userId}
	</delete>
	
	 <!-- ðŸ” ì‚¬ìš©ìžê°€ í•´ë‹¹ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ ì—¬ë¶€ í™•ì¸ -->
	<select id="existsLike" resultType="boolean">
	    SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END AS isExist FROM LIKE_CNT WHERE BOD_IDX = #{bodIdx} AND USER_ID = #{userId}
	</select>
	
	<!-- ðŸ“Š BOARD_DEFAULT í…Œì´ë¸”ì˜ LIKE_CNT ì»¬ëŸ¼ ì—…ë°ì´íŠ¸ -->
	<update id="updateLikeCount" parameterType="map">
	    UPDATE BOARD_DEFAULT SET LIKE_CNT = LIKE_CNT + #{amount} WHERE BOD_IDX = #{bodIdx}
	</update>
	
	 <!-- ðŸ”¢ ê²Œì‹œê¸€ì˜ ëˆ„ì  ì¢‹ì•„ìš” ìˆ˜ ê°€ì ¸ì˜¤ê¸° -->
	<select id="getLikeCount" resultType="int">
	    SELECT count(lc.BOD_IDX) AS likeCnt FROM BOARD_DEFAULT bd 
	LEFT OUTER JOIN LIKE_CNT lc ON bd.BOD_IDX = lc.BOD_IDX
	WHERE bd.BOD_IDX = #{bodIdx}
	GROUP BY bd.BOD_IDX, bd.BOD_CONSTENT, bd.BOD_TITLE , bd.REG2_DATE ,bd.REG_ID
	</select>

	<!-- ì¢‹ì•„ìš” ë§Žì€ ìƒìœ„ 5ê°œ ê²Œì‹œê¸€ ì¡°íšŒ -->
<select id="selectTop5LikedBoards" resultType="BoardDefaultVO">
    SELECT 
        bd.BOD_IDX,
        bd.BOD_TITLE,
        bd.BOD_CONSTENT,
        bd.REG2_DATE,
        bd.REG_ID,
        COUNT(lc.BOD_IDX) AS likeCnt
    FROM BOARD_DEFAULT bd
    LEFT JOIN LIKE_CNT lc ON bd.BOD_IDX = lc.BOD_IDX
    GROUP BY bd.BOD_IDX, bd.BOD_TITLE, bd.BOD_CONSTENT, bd.REG2_DATE, bd.REG_ID
    ORDER BY likeCnt DESC
    FETCH FIRST 5 ROWS ONLY
</select>

<!-- ì‹ ê³  ì—¬ë¶€ í™•ì¸  (ì™„ë£Œ : 2025-05-29)-->
	<select id="checkReport" resultType="int">
	  SELECT COUNT(*) FROM REPORT_CNT WHERE BOD_IDX = #{bodIdx} AND USER_ID = #{userId}
	</select>
	
	<!-- ì‹ ê³  ë“±ë¡ -->
	<insert id="addReport">
	  INSERT INTO REPORT_CNT (BOD_IDX, USER_ID) 
	  VALUES (#{bodIdx}, #{userId})
	</insert>
	
	 <!-- ðŸ”¢ ê²Œì‹œê¸€ì˜ ëˆ„ì  ì‹ ê³  ìˆ˜ ê°€ì ¸ì˜¤ê¸° -->
	<select id="getReportCount" resultType="int">
	    SELECT count(lc.BOD_IDX) AS reportCnt FROM BOARD_DEFAULT bd 
	LEFT OUTER JOIN REPORT_CNT lc ON bd.BOD_IDX = lc.BOD_IDX
	WHERE bd.BOD_IDX = #{bodIdx}
	GROUP BY bd.BOD_IDX, bd.BOD_CONSTENT, bd.BOD_TITLE , bd.REG2_DATE ,bd.REG_ID
	</select>
	
	 <!-- ðŸ” ì‚¬ìš©ìžê°€ í•´ë‹¹ ê²Œì‹œê¸€ì— ì‹ ê³ ë¥¼ ëˆŒë €ëŠ”ì§€ ì—¬ë¶€ í™•ì¸ -->
	<select id="existsReport" resultType="boolean">
	    SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END AS isExist FROM REPORT_CNT WHERE BOD_IDX = #{bodIdx} AND USER_ID = #{userId}
	</select>
	
	<!-- ðŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ (REPORT_CNT í…Œì´ë¸”ì—ì„œ ì‚­ì œ) -->
	<delete id="removeReport">
	    DELETE FROM REPORT_CNT WHERE BOD_IDX = #{bodIdx} AND USER_ID = #{userId}
	</delete>

	<!-- ì‹ ê³  3ê±´ ì´ìƒ ê²Œì‹œê¸€ ì¡°íšŒ -->
<select id="selectReportedBoards" resultType="BoardDefaultVO">
    SELECT 
        bd.BOD_IDX,
        bd.BOD_TITLE,
        bd.BOD_CONSTENT,
        bd.REG2_DATE,
        bd.REG_ID,
        bd.IS_VISIBLE,
        COUNT(rc.BOD_IDX) AS reportCnt
    FROM BOARD_DEFAULT bd
    JOIN REPORT_CNT rc ON bd.BOD_IDX = rc.BOD_IDX
    GROUP BY bd.BOD_IDX, bd.BOD_TITLE, bd.BOD_CONSTENT, bd.REG2_DATE, bd.REG_ID, bd.IS_VISIBLE
    HAVING COUNT(rc.BOD_IDX) >= 1
    ORDER BY reportCnt DESC
</select>

<!-- ê²Œì‹œê¸€ ë¸”ë¼ì¸ë“œì²˜ë¦¬ -->
	<update id="blockBoard" parameterType="BoardDefaultVO">
		UPDATE BOARD_DEFAULT
		SET IS_VISIBLE = #{isVisible}
		WHERE BOD_IDX = #{bodIdx}
	</update>

</mapper>